<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Minutos Escuchados (Recientes)</title>
  <style>
    body {
      background-color: rgb(248, 71, 218);
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      color: rgb(232, 48, 155);
    }

    .container {
      background-color: #C8A2C8;
      padding: 20px;
      min-height: 100vh;
      border-radius: 30px;
      border: 3px dotted aqua;
      box-shadow: 10px 10px 0px 0px palevioletred;
      text-align: center;
      margin: 30px auto;
      max-width: 600px;
    }

    h1 {
      color: aqua;
      border-radius: 30px;
    }

    .minutes-fixed {
      background-color: white;
      color: rgb(232, 48, 155);
      padding: 10px;
      font-size: 28px;
      font-weight: bold;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .update-note {
      font-size: 14px;
      color: white;
      margin-bottom: 20px;
    }

    button {
      background-color: rgb(207, 47, 135);
      width: 300px;
      height: 40px;
      border-radius: 30px;
      border-style: dotted;
      border-color: rgb(140, 14, 104);
      margin: 10px 0;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      background-color: rgb(236, 115, 224);
    }

    h4 {
      color: white;
      margin-top: 30px;
      border-bottom: 2px solid white;
      padding-bottom: 5px;
    }

    .track-list {
      text-align: left;
      padding: 10px;
      max-height: 300px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      margin: 20px;
    }

    .track-item {
      padding: 6px;
      margin-bottom: 5px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .track-count {
      color: #80d8ff;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Minutos Escuchados (Recientes)</h1>
    <button id="login">Conectar con Spotify</button>
    <button id="reset">Borrar Minutos</button>
    <div id="output"></div>
  </div>

  <script>
    const clientId = "c2d05e3f90e645a1828661c9d618f0d1";
    const redirectUri = "http://127.0.0.1:5500/spotify.html";
    const scope = "user-read-recently-played";

    function generateRandomString(length) {
      const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let text = '';
      for (let i = 0; i < length; i++) {
        text += possible.charAt(Math.floor(Math.random() * possible.length));
      }
      return text;
    }

    async function generateCodeChallenge(codeVerifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(codeVerifier);
      const digest = await window.crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/=/g, '')
        .replace(/\+/g, '-')
        .replace(/\//g, '_');
    }

    document.getElementById("login").addEventListener("click", async () => {
      const codeVerifier = generateRandomString(64);
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      localStorage.setItem("code_verifier", codeVerifier);

      const args = new URLSearchParams({
        response_type: "code",
        client_id: clientId,
        scope: scope,
        redirect_uri: redirectUri,
        code_challenge_method: "S256",
        code_challenge: codeChallenge
      });

      window.location = "https://accounts.spotify.com/authorize?" + args;
    });

    document.getElementById("reset").addEventListener("click", () => {
      localStorage.removeItem("minutosRecientes");
      document.getElementById("output").innerHTML = `<div class="minutes-fixed">0 minutos</div><div class="update-note">Minutos reiniciados.</div>`;
    });

    async function fetchAccessToken(code) {
      const codeVerifier = localStorage.getItem("code_verifier");

      const body = new URLSearchParams({
        grant_type: "authorization_code",
        code: code,
        redirect_uri: redirectUri,
        client_id: clientId,
        code_verifier: codeVerifier
      });

      const response = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: body
      });

      const data = await response.json();
      return data.access_token;
    }

    async function getRecentTracks(token) {
      const response = await fetch("https://api.spotify.com/v1/me/player/recently-played?limit=50", {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      const data = await response.json();

      let trackMap = new Map();
      let totalMs = 0;

      data.items.forEach(item => {
        const name = item.track.name;
        const duration = item.track.duration_ms;
        totalMs += duration;

        if (trackMap.has(name)) {
          trackMap.set(name, trackMap.get(name) + 1);
        } else {
          trackMap.set(name, 1);
        }
      });

      const totalMinutes = Math.round(totalMs / 60000);
      const stored = parseInt(localStorage.getItem("minutosRecientes") || "0");
      const updated = stored + totalMinutes;

      localStorage.setItem("minutosRecientes", updated);

      const output = document.getElementById("output");
      output.innerHTML = `
        <div class="minutes-fixed">${updated} minutos</div>
        <div class="update-note">+${totalMinutes} nuevos minutos agregados de canciones recientes.</div>
        <h4>Canciones reproducidas</h4>
        <div class="track-list">
          ${Array.from(trackMap.entries()).map(([name, count]) => `
            <div class="track-item">
              ${name} ${count > 1 ? `<span class="track-count">*${count}</span>` : ''}
            </div>
          `).join('')}
        </div>
      `;
    }

    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get("code");

    if (code) {
      fetchAccessToken(code).then(token => {
        getRecentTracks(token);
        window.history.replaceState({}, document.title, "/spotify.html");
      }).catch(err => {
        document.getElementById("output").innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
      });
    }
  </script>
</body>
</html>
